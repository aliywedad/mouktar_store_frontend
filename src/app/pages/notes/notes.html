<html dir="rtl" lang="ar">
  <mat-card class="cardWithShadow">
    <mat-card-content class="mat-card-content">
      <!-- Tabs -->
      <mat-tab-group>
        <!-- البحث -->
        <mat-tab label="بحث">
          <div class="card">
            <div class="form">
              <div class="form-item">
                <label>إلى</label>
                <input
                  class="date"
                  type="date"
                  [(ngModel)]="toDate"
                  name="toDate"
                />
              </div>

              <div class="form-item">
                <label>من</label>
                <input
                  class="date"
                  type="date"
                  [(ngModel)]="fromDate"
                  name="fromDate"
                />
              </div>
              <div class="form-item">
                <label>رقم الهاتف</label>
                <input
                  class="date"
                  type="number"
                  [(ngModel)]="tel"
                  name="tel"
                />
              </div>
            </div>

            <div style="width: fit-content; padding-top: 10px">
              <button class="btn btn-primary" (click)="loadData()">بحث</button>
            </div>
          </div>
        </mat-tab>
        <!-- إضافة ملاحظة جديدة -->
        <mat-tab label="إضافة ملاحظة جديدة">
          <div class="card">
            <div class=" " *ngIf="!isLoading" class="form">
              <form novalidate>
                <div class="p">
                  <div class="row">
                    <!-- نص الملاحظة -->
                    <div class="col-6 px-3" style="min-width: 300px">
                      <mat-label class="f-w-600 m-b-8 d-block"
                        >الملاحظة</mat-label
                      >
                      <textarea
                        style="min-height: 200px; min-width: 500px"
                        [(ngModel)]="note.note"
                        name="note"
                        required
                        placeholder="أدخل الملاحظة هنا"
                      ></textarea>
                    </div>
                    <div class="row">
                      <div class="form-item">
                        <label>رقم الهاتف</label>
                        <input
                          class="date"
                          type="number"
                          [(ngModel)]="note.tel"
                          name="tel"
                        />
                      </div>
                        <div class="form-item">
                        <label>الاسم  </label>
                        <input
                          class="date"
                          type="text"
                          [(ngModel)]="note.name"
                          name="tel"
                        />
                      </div>

                    </div>
                  </div>
                </div>
              </form>
            </div>
            <!-- الأزرار -->
            <div class="m-t-12">
              <button
                mat-stroked-button
                type="button"
                color="primary"
                (click)="onSubmit()"
                [disabled]="isLoading"
              >
                <mat-progress-spinner
                  *ngIf="isLoading"
                  mode="indeterminate"
                  diameter="20"
                  strokeWidth="4"
                  color="primary"
                ></mat-progress-spinner>
                <span *ngIf="!isLoading">حفظ</span>
              </button>

              <button type="button" mat-stroked-button color="warn">
                إلغاء
              </button>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>

      <!-- قائمة الملاحظات -->
      <mat-card-title class="title">قائمة الملاحظات</mat-card-title>

      <loading *ngIf="isLoading"></loading>

      <div *ngIf="!isLoading" class="table-responsive">
        <div class="notes-con">
          <div class="note" *ngFor="let item of notes; trackBy: trackById">
            <div class="note-content">
              <p>الملاحظة:</p>
              {{ item.note }}
            </div>

            <div>
              <mat-accordion>
                <mat-expansion-panel hideToggle>
                  <mat-expansion-panel-header>
                    <mat-panel-title class="p-0">
                      <div class="footer">
                        <!-- التاريخ والحذف -->
                        <div class="f-item" style="justify-content: start">
                          <span class="date">
                            <i
                              class="fa-regular fa-trash-can"
                              style="
                                width: 20px;
                                margin-left: 10px;
                                cursor: pointer;
                                color: red;
                              "
                              (click)="deleteNote(item.id)"
                            ></i>
                            <i class="fa-regular fa-clock"></i>
                            {{ formatDate(item.date) }}
                          </span>
                        </div>

                        <!-- التعليقات -->
                        <div class="f-item">
                          <span class="date">
                            <i class="fa-regular fa-comments"></i>
                            {{ item.comments ? item.comments.length : 0 }}
                          </span>
                        </div>

                        <!-- الزبون -->
                        <div
                          class="f-item"
                          style="justify-content: end"
                         >
                          <span class="date"  >
                            {{ item.name }}
                            <span class="w-[200px] h-1"></span>
                            <span>{{ item.tel }}</span>
                            <i
                              *ngIf="item.name"
                              class="fa-solid fa-user-tie"
                            ></i>
                          </span>
                        </div>
                      </div>
                    </mat-panel-title>
                  </mat-expansion-panel-header>

                  <!-- إضافة تعليق -->
                  <div class="flex mx-4">
                    <i
                      (click)="sendComment(item)"
                      class="fa-solid fa-paper-plane"
                      style="
                        padding: 10px;
                        background-color: rgb(197, 221, 248);
                        border-radius: 100%;
                        cursor: pointer;
                      "
                    ></i>
                    <input
                      placeholder="أضف تعليق جديد"
                      class="date"
                      [(ngModel)]="comments_text"
                      name="newComment"
                    />
                  </div>

                  <!-- التعليقات -->
                  <div class="comments">
                    <div class="comment" *ngFor="let it of item.comments">
                      <div class="comment-content">{{ it.comment }}</div>
                      <div class="c-date">{{ formatDate(it.date) }}</div>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</html>
